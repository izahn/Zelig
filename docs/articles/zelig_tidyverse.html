<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zelig and the Tidyverse • Zelig</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/paper/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">Zelig Project</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/quickstart.html">Quickstart</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html#section-zelig-overview">Zelig Overview</a>
    </li>
    <li>
      <a href="../articles/index.html#section-core-zelig-model-details">Zelig Model Details</a>
    </li>
    <li>
      <a href="../articles/index.html#section-other">Other</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Function Reference
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html#section-main-zelig-workflow">Workflow</a>
    </li>
    <li>
      <a href="../reference/index.html#section-estimation-methods">Estimation Methods</a>
    </li>
    <li>
      <a href="../reference/index.html#section-exterior-interaction-functions">Interacting Outside of Zelig</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    About
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/about.html">Contact/Development Team/Citation</a>
    </li>
    <li>
      <a href="../articles/roadmap.html">Development Roadmap</a>
    </li>
    <li>
      <a href="https://iqss.github.io/rpackagemetrics/">Zelig Adoption Metrics</a>
    </li>
    <li>
      <a href="https://raw.githubusercontent.com/IQSS/Zelig/master/.iqss_reportcard.yml">Statistical Software Devepment Reportcard</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://medium.com/zelig-dev/archive">
    <span class="fa fa-medium"></span>
     
    Dev-Blog
  </a>
</li>
<li>
  <a href="https://twitter.com/zeligproject">
    <span class="fa fa-twitter fa-2x"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/IQSS/Zelig">
    <span class="fa fa-github fa-2x"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Zelig and the Tidyverse</h1>
            
            <h4 class="date">2017-11-03</h4>
          </div>

    
    
<div class="contents">
<p><em>Built using Zelig version 5.1.4</em></p>
<p>Many researchers integrate tools from the “<a href="http://tidyverse.org/">tidyverse</a>” into their data workflows. The tidyverse includes a number of packages to read data into R–<a href="https://CRAN.R-project.org/package=readr">readr</a>–, transform it for analysis– <a href="https://cran.r-project.org/web/packages/tibble/vignettes/tibble.html">tibble</a>, <a href="https://CRAN.R-project.org/package=tidyr">tidyr</a>, purr, and dplyr, and visualise the results with <a href="http://docs.ggplot2.org/current/">ggplot2</a>. All of these packages can be loaded in R by loading the tidyverse package:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)</code></pre></div>
<p>Zelig can be easily slotted into this workflow for model estimation and identifying quantities of interest. Most Zelig estimation models require underlying data to be in the “tidy” format that the tidyverse creates. Zelig’s three step workflow can be organized very well using <a href="http://r4ds.had.co.nz/pipes.html">pipes</a> (<code>%&gt;%</code>) that the tidyverse advocates. Using pipes with Zelig will make your code more legible and computationally efficient.</p>
<div id="what-is-tidy-data" class="section level2">
<h2 class="hasAnchor">
<a href="#what-is-tidy-data" class="anchor"></a>What is “tidy data”</h2>
<p>“Tidy” data is defined as having three qualities <a href="https://www.jstatsoft.org/article/view/v059i10/v59i10.pdf">(Wickham 2014, 4)</a>:</p>
<ol style="list-style-type: decimal">
<li><p>Each variable forms a column.</p></li>
<li><p>Each observation forms a row.</p></li>
<li><p>Each type of observational unit forms a table.</p></li>
</ol>
<p>Data formatted in this way is ideal for most Zelig models.</p>
</div>
<div id="analyzing-tidy-data-with-pipes" class="section level2">
<h2 class="hasAnchor">
<a href="#analyzing-tidy-data-with-pipes" class="anchor"></a>Analyzing tidy data with pipes</h2>
<p>This example shows one way to integrate the Tidyverse and Zelig into one workflow.</p>
<p>Imagine we used the Tidyverse to create a data set in tidy format that we want to analyse with Zelig:</p>
<pre><code>##              Fertility Agriculture Examination
## Courtelary        80.2        17.0          15
## Delemont          83.1        45.1           6
## Franches-Mnt      92.5        39.7           5
## Moutier           85.8        36.5          12
## Neuveville        76.9        43.5          17
## Porrentruy        76.1        35.3           9</code></pre>
<p>We could then analyse it with Zelig and plot quantities of interest using Tidyverse’s pipe operator. Note the use of <code>data = .</code>. This tells the pipe to enter the <code>swiss</code> data object as the value of <code>zelig</code>’s data argument:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(Zelig)
<span class="kw">library</span>(tidyverse)

swiss <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="../reference/zelig.html">zelig</a></span>(Fertility <span class="op">~</span><span class="st"> </span>Agriculture <span class="op">+</span><span class="st"> </span>Examination, <span class="dt">model =</span> <span class="st">'ls'</span>, <span class="dt">data =</span> ., 
          <span class="dt">cite =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/setx.html">setx</a></span>(<span class="dt">Agriculture =</span> <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">90</span>, <span class="dt">by =</span> <span class="dv">5</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/sim.html">sim</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">plot</span>()</code></pre></div>
<p><img src="zelig_tidyverse_files/figure-html/unnamed-chunk-3-1.png" width="480"></p>
<p>We could also find first differences by including <code>setx1</code> in the workflow:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">swiss <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="../reference/zelig.html">zelig</a></span>(Fertility <span class="op">~</span><span class="st"> </span>Agriculture <span class="op">+</span><span class="st"> </span>Examination, <span class="dt">model =</span> <span class="st">'ls'</span>, <span class="dt">data =</span> ., 
          <span class="dt">cite =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/setx.html">setx</a></span>(<span class="dt">Agriculture =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/setx1.html">setx1</a></span>(<span class="dt">Agriculture =</span> <span class="dv">90</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/sim.html">sim</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">plot</span>()</code></pre></div>
<p><img src="zelig_tidyverse_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>Note that piping does not work with <a href="zelig5_vs_zelig4.html">Zelig 5’s reference class syntax</a>.</p>
</div>
<div id="zelig-and-ggplot2" class="section level2">
<h2 class="hasAnchor">
<a href="#zelig-and-ggplot2" class="anchor"></a>Zelig and ggplot2</h2>
<p>Zelig’s in-house plots are built using base R plotting functionality. You may want to take the quantities of interest simulated by Zelig and create custom plots with other tools, such as ggplot2.</p>
<p>The function <code>zelig_qi_to_df</code> extracts quantities of interest simulated by <code>sim</code> and returns them in a data frame formatted to follow tidy data principles. This output could be easily plotted with ggplot2.</p>
<p>Using the example analysis from before:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sims.full &lt;-<span class="st"> </span>swiss <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">                </span><span class="kw"><a href="../reference/zelig.html">zelig</a></span>(Fertility <span class="op">~</span><span class="st"> </span>Agriculture <span class="op">+</span><span class="st"> </span>Examination, <span class="dt">model =</span> <span class="st">'ls'</span>, <span class="dt">data =</span> ., 
                      <span class="dt">cite =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span>
<span class="st">                </span><span class="kw"><a href="../reference/setx.html">setx</a></span>(<span class="dt">Agriculture =</span> <span class="kw">seq</span>(<span class="dv">1</span>, <span class="dv">90</span>, <span class="dt">by =</span> <span class="dv">5</span>)) <span class="op">%&gt;%</span>
<span class="st">                </span><span class="kw"><a href="../reference/sim.html">sim</a></span>() <span class="op">%&gt;%</span>
<span class="st">                </span><span class="kw"><a href="../reference/zelig_qi_to_df.html">zelig_qi_to_df</a></span>()

<span class="kw">head</span>(sims.full)</code></pre></div>
<pre><code>##   setx_value Agriculture Examination expected_value predicted_value
## 1          x           1    16.48936       71.49423        81.45902
## 2          x           1    16.48936       76.06177        89.29726
## 3          x           1    16.48936       75.29747        79.91847
## 4          x           1    16.48936       74.45397        75.41513
## 5          x           1    16.48936       82.53474        82.67539
## 6          x           1    16.48936       68.48948        72.47520</code></pre>
<p>Each row contains information for an individual “observation”, i.e. a quantity of interest calculated from one draw of the model parameters from the multivariate normal distribution.</p>
<p>The first three columns of the object returned by <code>zelig_qi_to_df</code> in this case contain information that identifies the scenario that the quantity of interest is from. For example, the first row is from a scenario where <code>Agriculture</code> is fitted at <code>1</code> and <code>Examination</code> is fitted at the sample mean 16.4893617. The <code>setx_value</code> column identifies if the values were fitted by a <code>setx</code> call as <code>x</code> or <code>x1</code>–a contrasting scenario used to find first differences.</p>
<p>The final two columns contain the expected and predicted value of the quantity of interest, respectively.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a></p>
<p>Typically when we plot simulated quantities of interest, we would be interested in showing the central interval of the simulated distribution. This involves finding the central interval for each simulation scenario for some range, e.g. the central 95% of simulations. Zelig now includes a helper function <code>qi_slimmer</code> that takes the output of <code>zelig_qi_to_df</code> and finds the desired central interval for each scenario. For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sims.slimmed &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qi_slimmer.html">qi_slimmer</a></span>(sims.full)</code></pre></div>
<pre><code>## Slimming Expected Values . . .</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(sims.slimmed)</code></pre></div>
<pre><code>##   setx_value Agriculture Examination qi_ci_min qi_ci_median qi_ci_max
## 1          x           1    16.48936  65.96294     74.67966  83.66744
## 2          x           6    16.48936  66.36062     74.18883  82.39234
## 3          x          11    16.48936  66.75830     73.68367  81.04527
## 4          x          16    16.48936  67.04422     73.23253  79.78309
## 5          x          21    16.48936  67.20951     72.77276  78.68214
## 6          x          26    16.48936  67.46554     72.32896  77.51993</code></pre>
<p>Now we have one row for each scenario. This contains the columns <code>qi_ci_min</code>, <code>qi_ci_median</code>, and <code>qi_ci_max</code> for the central interval of the simulations from each scenario. By default <code>qi_ci_min</code> and <code>qi_ci_max</code> contain central interval bounds at the lower 2.5 and upper 97.5 percentiles, respectively. <code>qi_ci_median</code> contains the simulated distribution’s median. The interval can be changed with the <code>ci</code> argument. You can choose expected value (<code>ev</code>) or predicted value (<code>pv</code>) with the <code>qi_ci_type</code> argument.</p>
<p>Now we have everything to make a ggplot2 plot summarizing the simulated quantity of interest:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(sims.slimmed, <span class="kw">aes</span>(Agriculture, qi_ci_median)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> qi_ci_min, <span class="dt">ymax =</span> qi_ci_max), <span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">ylab</span>(<span class="st">'Expected Fertility'</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="zelig_tidyverse_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<div id="get-in-touch" class="section level3">
<h3 class="hasAnchor">
<a href="#get-in-touch" class="anchor"></a>Get in touch</h3>
<p>We are also considering in the future whether to generate Zelig’s default plots with ggplot2. We’d love to hear your thoughts: <a href="https://github.com/IQSS/Zelig/issues">GitHub <i class="fa fa-github" aria-hidden="true"></i></a>, <a href="https://groups.google.com/forum/#!forum/zelig-statistical-software">Google Groups <i class="fa fa-google" aria-hidden="true"></i></a>, or <a href="https://gitter.im/Zelig-dev/CommunityQueries">Gitter Chat <i class="fa fa-comments-o" aria-hidden="true"></i></a>.</p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>“Depending on the issue being studied, the expected or mean value of the dependent variable may be more interesting than a predicted value. The difference is subtle but important. A predicted value contains both fundamental and estimation uncertainty, whereas an expected value averages over the fundamental variability arising from sheer randomness in the world, leaving only the estimation uncertainty caused by not having an infinite number of observations. Thus, predicted values have a larger variance than expected values, even though the average should be nearly the same in both cases.” From <a href="http://www.jstor.org.ezp-prod1.hul.harvard.edu/stable/2669316">King, Tomz, and Wittenberg (2000, 350)</a><a href="#fnref1">↩</a></p></li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#what-is-tidy-data">What is “tidy data”</a></li>
      <li><a href="#analyzing-tidy-data-with-pipes">Analyzing tidy data with pipes</a></li>
      <li><a href="#zelig-and-ggplot2">Zelig and ggplot2</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Christine Choirat, Christopher Gandrud, James Honaker, Kosuke Imai, Gary King, Olivia Lau.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
